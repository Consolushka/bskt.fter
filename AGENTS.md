# AGENTS.md

Документ для ИИ-агентов, которые вносят изменения в проект.

## 1. Цель проекта

Сервис собирает баскетбольную статистику из внешних провайдеров и сохраняет данные в PostgreSQL:
- игры,
- командную статистику,
- статистику игроков,
- служебные watermark-метки для опроса.

## 2. Актуальная модель запуска

Инфраструктура:
- Docker используется только для PostgreSQL (`docker-compose`, сервис `db`).
- Go-процессы запускаются локально (без golang-контейнера).

Основной рантайм:
- `app/cmd/scheduler/main.go` — фоновый процесс.

Дополнительно:
- `app/cmd/debug-server/main.go` — легкий HTTP-сервер для ручного триггера обработки.

Текущая стратегия опроса:
- цикл каждые 5 минут,
- обработка за текущие UTC-сутки,
- watermark хранится в БД (`poll_watermarks`).

## 3. Архитектурный стиль

Проект следует гексагональной архитектуре (ports/adapters):
- `app/internal/core` — доменные модели,
- `app/internal/ports` — интерфейсы,
- `app/internal/adapters` — реализации интерфейсов (БД, провайдеры, scheduler-adapters),
- `app/internal/service` — use-case/оркестрация,
- `app/internal/infra` — низкоуровневые клиенты внешних API,
- `app/database/migrations` — SQL-миграции.

Правило:
- новый репозиторий/внешняя зависимость сначала задается в `ports`,
- затем реализуется в соответствующем adapter-пакете,
- сервисы зависят от интерфейсов, а не от concrete-типов.

## 4. Паттерн файлов и именования

### 4.1 Репозитории

Для каждого репозитория:
- интерфейс в `app/internal/ports/*_repo.go`,
- адаптер в `app/internal/adapters/<name>_repo/gorm.go`,
- конструктор `NewGormRepo(...)`.

### 4.2 Модели

- доменные модели лежат в соответствующих пакетах `app/internal/core/<domain>`.
- не смешивать модели разных доменов в одном пакете без необходимости.

### 4.3 Моки

- моки лежат рядом с адаптером/пакетом, где используются,
- mock обязан соответствовать текущему интерфейсу из `ports`.

## 5. Поток обработки данных

Базовый поток:
1. scheduler запускает задачи,
2. orchestrator выбирает турниры,
3. processor запрашивает игры у stats provider,
4. для новых игр выполняется enrichment (детали/игроки/статы),
5. persistence сохраняет сущности в БД.

Важно для лимитов API:
- `API_NBA` реализован двухфазно:
  - `GetGamesStatsByPeriod` — легкий листинг игр,
  - `EnrichGameStats` — тяжелая догрузка только для новых игр.

## 6. База данных и миграции

- миграции: `app/database/migrations`.
- перед изменением моделей проверить существующие индексы/уникальности.
- критерии проверки существования игры должны соответствовать реальному unique-индексу БД.

## 7. Тестовая стратегия

Используется:
- `testing`,
- `gomock`,
- `testify/assert`.

Минимальные требования к новым изменениям:
- happy-path,
- error-path,
- continue/skip-ветки,
- проверка взаимодействия с mock-зависимостями.

Если меняется сигнатура интерфейса:
- обновить все моки,
- обновить тесты сервисов/оркестраторов,
- убедиться, что пакет(ы) с этими тестами компилируются и проходят.

## 8. Правила изменения кода

1. Не нарушать разделение по слоям.
2. Не тянуть adapter-зависимости напрямую в `core`.
3. Не добавлять новый флоу без порта/контракта.
4. Для логики с ограничениями внешних API — сначала проектировать минимальное число запросов.
5. Для конкурентного исполнения избегать race в goroutine-замыканиях.

## 9. Чеклист для ИИ-агента перед завершением задачи

1. Обновлены ли интерфейсы и их реализации синхронно?
2. Обновлены ли моки под текущие интерфейсы?
3. Добавлены/обновлены тесты под новую ветвящуюся логику?
4. Применимы ли миграции к чистой базе?
5. Обновлены ли `README.md` и этот `AGENTS.md`, если поведение/архитектура изменилась?

## 10. Обязательное правило актуализации

КРИТИЧНО:

Любое изменение, которое затрагивает архитектуру, флоу данных, контракты интерфейсов, стратегию опроса, структуру БД, правила тестирования или правила разработки, ОБЯЗАТЕЛЬНО должно сопровождаться обновлением этого файла `AGENTS.md`.

Если после изменения код и `AGENTS.md` расходятся — задача считается выполненной некорректно.
